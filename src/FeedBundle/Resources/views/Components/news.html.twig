<style type="text/css">
    #main_news {
        margin-bottom: 20px;
    }
</style>

<script>
    $(document).ready(function() {
        function news() {
            var templateManager,
                ajaxHandler,
                offsetHandler,
                isClearContent,
                moreButton = $('#more'),
                mainNews = $('#main_news');

            function offsetManager() {
                var offset = 0;

                function getOffset () {
                    return offset;
                }
                function addOffset (count) {
                    offset += count;
                }
                function clearOffset () {
                    offset = 0;
                }
                function setOffset (count) {
                    offset = count;
                }

                return {
                    getOffset : getOffset,
                    setOffset : setOffset,
                    clearOffset: clearOffset,
                    addOffset: addOffset
                }
            }

            function ajaxSuccess(resolvedData) {
                var newsTemplate = templateManager.getTemplate('news');

                if ($.isPlainObject(resolvedData)
                    && 'data' in resolvedData
                    && newsTemplate
                ) {
                    if (isClearContent) {
                        mainNews.empty();
                        isClearContent = false;
                    }
                    mainNews.append(newsTemplate({
                        news: resolvedData.data
                    }));
                }
                if ($.isPlainObject(resolvedData)
                    && 'error' in resolvedData
                ) {
                    var error = {
                        message: resolvedData.error,
                        name: "Server error",
                        code: 500
                    };
                    errorHandler(error);
                }

                offsetHandler.addOffset(resolvedData.count);
                ajaxHandler.addParameter('offset', offsetHandler.getOffset());

                if (offsetHandler.getOffset() >= resolvedData.total) {
                    moreButton.hide();
                } else {
                    moreButton.show();
                }
            }

            function ajaxError(jqXHR, textStatus) {
                var error = {
                    message: "Error from server with status " + textStatus,
                    name: "Ajax call"
                };
                errorHandler(error);
            }

            function getNews() {
                if (!ajaxHandler.send()) {
                    var error = {
                        message: "Ajax is not inited",
                        name: "Ajax call"
                    };
                    errorHandler(error);
                }
            }

            function init() {
                moreButton.hide();
                offsetHandler = offsetManager();
                offsetHandler.clearOffset();
                templateManager = templateHandler();
                templateManager.process('news');
                ajaxHandler = ajaxManager();
                ajaxHandler.init('{{ ajax_url }}', '{{ format }}', ajaxSuccess, ajaxError);

                isClearContent = false;

                moreButton.click(function () {
                    $(document).trigger('moreClickDocument', {});
                    getNews();
                });

                $(document).trigger('widgetInited', {widgetName: getName()});
            }

            function run(processData) {
                ajaxHandler.addParameters(processData);
                getNews();
            }
            
            function clearContent() {
                isClearContent = true;
                offsetHandler.clearOffset();
                ajaxHandler.addParameter('offset', offsetHandler.getOffset());
            }

            function getName() {
                return 'news';
            }

            return {
                init: init,
                run: run,
                clearContent: clearContent,
                getName: getName
            }
        }

        $(document).trigger('widgetLoaded', {widgetInstance: news()});
    });
</script>

<div id='main_news' class="subscribers-categoryClick"></div>

<!-- Pager -->
<button id='more' class='more btn btn-primary btn-block'>
    More <span class='caret'></span>
</button>

<script id='news' type='text/x-handlebars-template'>
    {% verbatim %}
        {{#news}}
            <h2>
                <a href='{{link}}'>{{title}}</a>
            </h2>
            <p><span class='glyphicon glyphicon-time'></span>{{pubDate}}</p>
            <img class='img-responsive' src='{{media.url}}' alt=''>
            <p>{{description}}</p>
            <a class='btn btn-primary' href='#'>Read More <span class='glyphicon glyphicon-chevron-right'></span></a>
        {{/news}}
    {% endverbatim %}
</script>