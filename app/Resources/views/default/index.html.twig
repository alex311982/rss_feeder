{% extends 'base.html.twig' %}

{% block title %}RSS feeds{% endblock %}

{% block javascripts_head %}
    {{ parent() }}

<script>
    $(document).ready(function() {
        function more() {
            var offset = 0;

            function getOffset () {
                return offset;
            }
            function setOffset (count) {
                offset += count;
            }

            return {
                getOffset : getOffset,
                setOffset : setOffset
            }
        }

        var feeds = function () {},
            offsetHandler = more();

        feeds.init = function (done, error) {
            var template,
                ajaxHandler = ajaxManager();

            if (!$.isFunction(done)) {
                done = function (resolvedData) {
                    var source = $('#news').html();
                    if (!template) {
                        template = Handlebars.compile(source);
                    }
                    if ($.isPlainObject(resolvedData)
                        && 'data' in resolvedData
                    ) {
                        $('#main_news').append(template({
                            news: resolvedData.data
                        }));
                    }
                    if ($.isPlainObject(resolvedData)
                        && 'error' in resolvedData
                    ) {
                        $('#alert').html(resolvedData.error).show();
                    } else {
                        $('#alert').html('').hide();
                    }
                    offsetHandler.setOffset(resolvedData.count);
                    if (offsetHandler.getOffset() >= resolvedData.total) {
                        $('#more').hide();
                    }
                };
            }
            if (!$.isFunction(error)) {
                error = function (jqXHR, textStatus) {
                    $('#alert').html('Error from server with status ' + textStatus).show();
                };
            }
            ajaxHandler.init('{{ ajax_url }}', '{{ format }}', done, error);

            return {
                process: function(processData) {
                    if (!ajaxHandler.send(processData)) {
                        $('#alert').html('Somethig wrong').show();
                    }
                }
            }
        };

        $('#alert').html('').hide();

        $('#more').click(
            function () {
                var count = offsetHandler.getOffset();
                feeds.init().process({offset : count})
            }
        );

        feeds.init().process({offset : offsetHandler.getOffset()});
    });
</script>
{% endblock %}

{% block content %}
    {% verbatim %}

    <div id='main_news'></div>
    <script id='news' type='text/x-handlebars-template'>
        {{#news}}
        <h2>
            <a href='{{link}}'>{{title}}</a>
        </h2>
        <p><span class='glyphicon glyphicon-time'></span>{{pubDate}}</p>

        <img class='img-responsive' src='{{media.url}}' alt=''>

        <p>{{description}}</p>
        <a class='btn btn-primary' href='#'>Read More <span class='glyphicon glyphicon-chevron-right'></span></a>

        {{/news}}
    </script>

    <!-- Pager -->
    <button id='more' class='more btn btn-primary btn-block'>
        More <span class='caret'></span>
    </button>

    {% endverbatim %}

{% endblock %}

{% block sidebar %}
    {{ render(controller('AppBundle:Category:index')) }}
{% endblock %}